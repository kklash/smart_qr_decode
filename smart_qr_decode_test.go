package main

import (
	"encoding/hex"
	"testing"
)

// https://vishnuravi.medium.com/how-do-verifiable-covid-19-vaccination-records-with-smart-health-cards-work-df099370b27a
//
// jwsToken := "eyJhbGciOiJFUzI1NiIsImtpZCI6IlVYR2dnMjVfM3ZockNPWVcxdHlGbE9YZDlTeEFNVi1SVF9UdUFIZkpXSlkifQ.3ZJLb9swEIT_SrC9ynohjSDd6hTI41AUaNpL4QNNrS0WfAgkJcQN9N-7SztIWyQ55RTdVhx-nBnyAVQI0MEQ4xi6oggjyjwY4eOAQschl8L3ocB7YUaNoSD1hB4ysNsddNVFXV-0ZX3e5G3TZjBL6B4gHkaE7ucT83_ch-Ow4oFQL-uUMZNVv0VUzr4qlG5WfdXCJgPpsUcbldDfpu0vlJEt7Qblf6APzOngPC_zinj8dz3ZXiNrPAY3eYl3yT6cFrJTHJBOa6IdndAB_kAZiTxp_d1rEjzu70oSPA7PgL9SHNrPHQqDR4gwShMPPlnS-JDO2KsZLfd46wae1zlsFgq4VRT-s4jMqtqP1aqsVnUJy5I966Z63c3NvxWHKOIUUly-8Ih8QbOQUlm8dH0iSNcru0_GwyFENKf3Qzcz6CZ3fl9ws0VQfSHnewLItBPqsoFls2QwnipIdnbo0bK3vxskkZNy8mmJw94pc0TUKXDJsaiqnfOG3iN7ETI6z8hehVGLVOf68uwKLXqhz65dGFUUmoqiErWLXyaz5a1Qpq96scH6XTZYt2_dYMMLC31_AA.j5H0TMm7eY4TkiOwfmke9Z-nH4vqflgeIB-EX4DmcCVeKKooqLKEXsdC3hPZdtUZ4NPkBfeVLV7g2XJiKB1Rmw"

var testFixtures = []struct {
	qrPayload  string
	headerJSON string
	cardJSON   string
	signature  string
}{
	{
		qrPayload:  "QR-Code:shc:/567629595326546034602925407728043360287028647167452228092863413255057006342559453264333756652537544008613440110853236357376462073262700740635904400355375526672637635926402336605736010645293153127074242839503869221276656659613823550959392807042040523367310736333369380342572058622954363312330010387771284276360808373955415975006521657620413628033224360775600966585861766174440756342036705459631131066654211044405233663823045921077670337055553341254341000345430656082606394561213109210758276252241072543911065054590034740766253631007240324533417303414077690768632608425755432229583567704054536355235767720373632924711036536357092035773465583522507760656111557706454360336935204406564463067639095425692939272921345209285565552021506220456039756750550469246177721003663835201035583112382733693527366823370758743859323535636538002923340530704531575507097452560477637025586807413739007007613268716835045268704165402976082812090945090654063373754227303428404063760011285911365334364063641155270360383354697203502674762524333057063677547709224506576312747003413657382765567431287121356870662563700536746560672855655366035330067375706262453376116464297412076754033940304323297052606865573426066033102439280977115956594126314134570911727430314368597709085526254040646668602469423143765277085204366768120970542709433945447105505544323231220604502020016768540661383555001150756359455028030066420839321255393040715466035040407553332332233935122253220569615974393220757757362072277407420769006140205724355509726541376038765336",
		headerJSON: `{"alg":"ES256","kid":"ULwk78XY2cQzqQqNc9O9l9_Fi82K8RXuSGQtjFFXFP4"}`,
		cardJSON:   `{"iss":"https://spec.smarthealth.cards/examples/issuer","nbf":1622690247.979,"vc":{"type":["https://smarthealth.cards#health-card","https://smarthealth.cards#immunization","https://smarthealth.cards#covid19"],"credentialSubject":{"fhirVersion":"4.0.1","fhirBundle":{"resourceType":"Bundle","type":"collection","entry":[{"fullUrl":"resource:0","resource":{"resourceType":"Patient","name":[{"family":"Anyperson","given":["John","B."]}],"birthDate":"1951-01-20"}},{"fullUrl":"resource:1","resource":{"resourceType":"Immunization","status":"completed","vaccineCode":{"coding":[{"system":"http://hl7.org/fhir/sid/cvx","code":"207"}]},"patient":{"reference":"resource:0"},"occurrenceDateTime":"2021-01-01","performer":[{"actor":{"display":"ABC General Hospital"}}],"lotNumber":"0000001"}},{"fullUrl":"resource:2","resource":{"resourceType":"Immunization","status":"completed","vaccineCode":{"coding":[{"system":"http://hl7.org/fhir/sid/cvx","code":"207"}]},"patient":{"reference":"resource:0"},"occurrenceDateTime":"2021-01-29","performer":[{"actor":{"display":"ABC General Hospital"}}],"lotNumber":"0000007"}}]}}}}`,
		signature:  "a6a7378d23ddfbcff196167f234fa85b94ccf5d4ca52d728d3f514c5b3433034cff426c2dab8e1c13300c737d002e1f0e16e2bfa35007c43ddeae9d54624b26d",
	},
	{
		qrPayload:  "QR-Code:shc:/567629095243206034602924374044603122295953265460346029254077280433602870286471674522280928613331456437653141590640220306450459085643550341424541364037063665417137241236380304375622046737407532323925433443326057360104413333527570752435036945652955560456532134341275386403316824406473453857292204440900303559452952006826505600550339666359775936093042093843697708700410035935662630262131684000336442677526685945265961385654232160612010575336603372416830094368087268583034220858653868405566737300676125522604302403684570446967365009635270603428764571693256573264396370103435043129720355532071362041710338407377455561123629414403691039073772267629582653595341365920676509072704756762393223665909237432547227110341752758564033075344643024205259213433223275231145112344442077504133374423657738732465036268045333500372292428680305752055066161205908590727574039273565100365453467620676070466562374456011640503052612603433352534627643734526297670536641110369320974692670435941656559530672526365744144392929372455403655296826416910330331702770525959062807257522393924313335716156446225321038684203745070327705435227392923353242241273761130335734312154002724683467287609315543752975265426124341547269386510063170735444033524323109036562255462334100753044505239593704336853601144044303067643563009455908314400052367685333606845283543332368052172450304695777120961747623331028343573401038623404535367200023435327675723580300766876627154233043006804230025103369507231500670446306070903575832014453337756590712383705676069074064360005643067283632385063256409252323366162400606120354527428123073066511712009226844663207632755572431336840456368371037205910610777322474",
		headerJSON: `{"zip":"DEF","alg":"ES256","kid":"3Kfdg-XwP-7gXyywtUfUADwBumDOPKMQx-iELL11W9s"}`,
		cardJSON:   `{"iss":"https://c19.cards/issuer","nbf":1591037940,"vc":{"type":["https://smarthealth.cards#covid19","https://smarthealth.cards#health-card","https://smarthealth.cards#immunization"],"credentialSubject":{"fhirVersion":"4.0.1","fhirBundle":{"resourceType":"Bundle","type":"collection","entry":[{"fullUrl":"resource:0","resource":{"resourceType":"Patient","name":[{"family":"Anyperson","given":["Johnathan","Biggleston III"]}],"birthDate":"1951-01-20"}},{"fullUrl":"resource:1","resource":{"resourceType":"Immunization","meta":{"security":[{"code":"IAL1.2"}]},"status":"completed","vaccineCode":{"coding":[{"system":"http://hl7.org/fhir/sid/cvx","code":"207"}]},"patient":{"reference":"resource:0"},"occurrenceDateTime":"2021-01-01","location":{"reference":"resource:3"},"performer":[{"actor":{"display":"ABC General Hospital"}}],"lotNumber":"Lot #0000001"}},{"fullUrl":"resource:2","resource":{"resourceType":"Immunization","status":"completed","vaccineCode":{"coding":[{"system":"http://hl7.org/fhir/sid/cvx","code":"207"}]},"patient":{"reference":"resource:0"},"occurrenceDateTime":"2021-01-29","performer":[{"actor":{"display":"ABC General Hospital"}}],"lotNumber":"Lot #0000007"}}]}}}}`,
		signature:  "61b3737a1e3d491da98abe14990fb698aa4840c4bf9459ba1430d08e4537dfdd1c6b023d2afde7f2d03a0aa62833894775f10b36a51996a47b44087b8f8ccc13",
	},
}

func TestDecodeSmartVaccineCard(t *testing.T) {
	for i, fixture := range testFixtures {
		headerJSON, cardJSON, signature, err := DecodeSmartVaccineCard(fixture.qrPayload)
		if err != nil {
			t.Errorf("Failed to decode vaccine card fixture %d: %s", i, err)
			continue
		}

		if headerJSON != fixture.headerJSON {
			t.Errorf(
				"decoded header JSON does not match\n"+
					"Wanted: %s\n"+
					"Got:    %s",
				fixture.headerJSON,
				headerJSON,
			)
			continue
		}

		if cardJSON != fixture.cardJSON {
			t.Errorf(
				"decoded vaccine card JSON does not match\n\n"+
					"Wanted: %s\n\n"+
					"Got:    %s",
				fixture.cardJSON,
				cardJSON,
			)
			continue
		}

		if sigHex := hex.EncodeToString(signature); sigHex != fixture.signature {
			t.Errorf(
				"decoded signature does not match\n"+
					"Wanted: %s\n"+
					"Got:    %s",
				fixture.signature,
				sigHex,
			)
			continue
		}
	}
}
